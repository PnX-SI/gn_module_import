<div class="card main">
    <div class="card-body">
        <div class="row">
            <div class="col-12 col-lg-7">
                <div class="card content">
                    <div class="card-body">
                        <div class="d-flex display justify-content-between">
                            <h5 class="card-title">Rapport d'import : {{ import?.id_import }}</h5>
                            <h5 class="card-title unfinished">{{ import?.is_finished ? '' : 'NON TERMINE'}}
                            </h5>
                        </div>
                        <p class="card-text"><b>Jeu de données : </b><a
                            routerLink="/metadata/dataset_detail/{{import?.id_dataset}}"
                            matTooltip="Voir dans le module Metadonnées"
                        >{{ import?.dataset_name }}</a></p>
                        <p class="card-text"><b>Fichier : </b>{{import?.full_file_name}} </p>
                    </div>
                </div>
                <div class="row">
                    <div [ngClass]="{'col-12 col-lg-6': import?.is_finished,
                                     'col-12': !import?.is_finished}">
                        <div class="card content">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9 col-md-7">
                                        <h5 class="card-title">Observations importées</h5>
                                        <div class="d-flex justify-content-center">
                                            <h5>({{import?.import_count || 0}} ligne(s)
                                                /
                                                {{import?.source_count}}) 
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="col-3 col-md-5 text-center">
                                        <img src="./assets/images/Donnee_icon.svg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="import?.is_finished" class="col-12 col-lg-6">
                        <div class="card content">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9 col-md-7">
                                        <h5 class="card-title">Taxons importés</h5>
                                        <div class="d-flex justify-content-center">
                                            <h5>{{ import?.taxa_count }}
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="col-3 col-md-5 text-center">
                                        <img src="./assets/images/Taxon_icon.svg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card content">
                    <div class="card-header">
                        <h5 class="card-title">Description de l'import</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p> <b>Date de soumission de l'import :  </b> {{import?.date_create_import | date:'dd/MM/yyyy'}}  </p>
                                <p> <b>Auteur :  </b> {{import?.author_name}} </p>
                                <p> <b>Nombre de lignes importées :  </b>
                                    ({{import?.import_count || 0}}
                                    /
                                    {{import?.source_count}}) </p>
                            </div>
                            <div class="col-6">
                                <p> <b> SRID : </b>  {{import?.srid}} </p>
                                <p><b> Encodage :</b>  {{import?.encoding}} </p>
                                <p><b>  Format : </b>{{import?.format_source_file}} </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card content">
                    <div class="card-header">
                        <h5 class="card-title">Correspondances</h5>
                    </div>
                    <div class="card-body">
                        <mat-expansion-panel>
                            <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                                <mat-panel-title>
                                    <h6> Champs ({{ fields?.length || 0 }} correspondance(s))
                                    </h6>
                                </mat-panel-title>
                            </mat-expansion-panel-header>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Champ source</th>
                                        <th>Champ cible</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let field of fields">
                                        <td> {{ field.source_field }}</td>
                                        <td> {{ field.target_field }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </mat-expansion-panel>
                        <mat-expansion-panel>
                            <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                            <mat-panel-title>
                                <h6> Nomenclature ({{ matchedNomenclature?.length || 0 }} correspondance(s))
                                </h6>
                            </mat-panel-title>
                            </mat-expansion-panel-header>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Champ source</th>
                                        <th>Champ cible</th>
                                        <th>Définition</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let field of matchedNomenclature">
                                        <td> {{ field.source_value }}</td>
                                        <td> {{ field.target_value }}</td>
                                        <td> {{ field.definition }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </mat-expansion-panel>
                    </div>
                </div>
                <div class="card content">
                    <div class="card-header">
                        <div class="d-flex justify-content-start">
                            <h5 class="card-title">
                                Données non importées - Erreurs
                            </h5>
                            <mat-icon color="warn">
                                priority_high
                            </mat-icon>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Type d'erreur</th>
                                    <th>Champ </th>
                                    <th>Description erreur</th>
                                    <th>Nombre d'erreur(s)</th>
                                    <th>Numéro des lignes en erreur </th>
                                </tr>
                
                            </thead>
                            <tbody>
                                <tr *ngFor="let i of import?.errors">
                                    <td> {{i.error_type}} </td>
                                    <td> {{i.column_error}} </td>
                                    <td> {{i.error_description}} <i> <br> {{i.comment}}</i> </td>
                                    <td> <span *ngIf="i?.id_rows && i?.id_rows.length > 0">{{i?.id_rows.length}} </span>  </td>
                                    <td> 
                                        <span *ngIf="i.id_rows.length>=10 && !i.show">{{i.id_rows.slice(0, maxErrorsLines).join(', ')}} ...
                                            <button 
                                                mat-icon-button 
                                                matTooltip="Voir plus"
                                                (click)="i.show=!i.show">
                                                <mat-icon>expand_more</mat-icon>
                                            </button>
                                        </span>
                                        <span *ngIf="i.id_rows.length<=10 || i.show">{{i.id_rows.join(', ')}}
                                            <button 
                                                mat-icon-button 
                                                matTooltip="Voir moins"
                                                *ngIf="i.id_rows.length>=10" 
                                                (click)="i.show=!i.show">
                                                <mat-icon>expand_less</mat-icon>
                                            </button>   
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div
                        class="d-flex flex-row-reverse"
                        *ngIf="import?.errors.length"
                    >
                        <button
                            class="mat-raised-button mat-primary"
                            (click)="_csvExport.onCSV(import?.id_import)"
                        > Exporter vos {{ import?.errors.length }} observations invalides </button>
                    </div>
                    </div>
                </div>
                <div class="card content">
                    <div class="card-header">
                        <div class="d-flex justify-content-start">
                            <h5 class="card-title">
                                Notes & corrections
                            </h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <need-fix 
                            [fix]="fix"
                            [importId]="import?.id_import">
                        </need-fix>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-5">
                <div class="card content"> 
                    <div class="card-header">
                        <h5 class="card-title">Export</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-center">
                            <button 
                            class="mat-raised-button mat-primary"
                            [class.spinner]="loading" 
                            [disabled]="loadingPdf"
                            (click)="exportAsPDF()"
                            >
                            Synthèse PDF
                            <mat-icon *ngIf="loadingPdf">
                                <mat-spinner color=warn diameter="30">
                                </mat-spinner>
                            </mat-icon>
                            </button>
                            <button
                                [attr.hidden]="fields === undefined || fields?.length == 0 ? true: null"
                                class="mat-raised-button mat-primary"
                                (click)="exportCorrespondances()"
                            >
                                Correspondances de champs
                            </button>
                            <button 
                                [attr.hidden]="matchedNomenclature === undefined || matchedNomenclature?.length == 0 ? true: null"
                                class="mat-raised-button mat-primary"
                                (click)="exportNomenclatures()"
                            >
                                Correspondances de nomenclatures
                            </button>
                            <button class="mat-raised-button mat-primary" hidden> Correspondances 
                                d’identifiants</button>
                        </div>
                    </div>
                </div>
                <div class="card content">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <h5 class="card-title">Périmètre géographique 
                                des données importées</h5>
                            </div>
                            <div class="col-4">
                                <button class="mat-raised-button mat-primary"
                                 (click)="goToSynthese(import?.id_dataset)">Afficher dans la synthèse</button>
                            </div>
                        </div>    
                    
                        <pnx-map
                            height="40vh"
                            searchBar="false"
                        >
                            <pnx-geojson
                                [geojson]="this.validBbox"
                                [zoomOnFirstTime]="true"
                            >
                            </pnx-geojson>
                        </pnx-map>
                    </div>
                </div>
                <div *ngIf="import?.is_finished" class="card content">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-7">
                                <h5 class="card-title">
                                    Répartition des taxons importés
                                </h5>
                            </div>
                            <div class="col-5">
                                <mat-select [(ngModel)]="rank" (ngModelChange)="onRankChange($event)">
                                    <mat-option *ngFor="let r of rankOptions" [value]="r">
                                        {{r}}
                                    </mat-option>
                                </mat-select>
                            </div>
                        </div>
                        
                        <div style="display: block">
                            <canvas id="chart" baseChart
                                [data]="doughnutChartData"
                                [labels]="doughnutChartLabels"
                                [chartType]="doughnutChartType"
                                [colors]="doughnutChartColors"
                                [options]="options">
                            </canvas>
                          </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
